class Provider{constructor(){let e=this;$("#menu-provider").on("click",(function(e){e.preventDefault(),$("#modal-provider").modal("show")})),$("#btn-new-provider").on("click",(function(e){e.preventDefault(),$("#page-provider").addClass("d-none"),$("#page-new-provider").removeClass("d-none"),$.get("./provider.json?action=control-panel",(function(e){$('#page-new-provider input[name="cp"]').autoComplete({source:e}).refresh()}))})),$("#page-new-provider .btn-outline-secondary").on("click",(function(t){t.preventDefault(),e.discardNew()})),$("#page-new-provider .btn-primary").on("click",(function(t){t.preventDefault();var n=$(this),a=$("#page-new-provider form").serialize();n.data("html",n.html()).css({width:n.outerWidth(),height:n.outerHeight()}).prop("disabled",!0).html('<div class="loader-inner ball-beat"><div></div><div></div><div></div></div>'),$("#page-new-provider input").prop("disabled",!0),$("#page-new-provider .is-invalid").removeClass("is-invalid"),$("#page-new-provider .invalid-feedback").remove(),$.post("./provider.json",a+"&__CSRF_TOKEN__="+$('input[name="__CSRF_TOKEN__"]').val(),(function(t){Object.keys(t.errors).length>0?$.each(t.errors,(function(e,t){$('#page-new-provider [name="'+e+'"]').addClass("is-invalid"),$('#page-new-provider [name="'+e+'"]').parent(".form-floating").addClass("is-invalid"),$('#page-new-provider [name="'+e+'"]').after('<div class="invalid-feedback">'+t+"</div>")})):(e.discardNew(),e.rebuildList(),e.refreshSelectList())}),"json").fail((function(){alert("Connection lost, please try again.")})).always((function(e){n.prop("disabled",!1).html(n.data("html")),$("#page-new-provider input").prop("disabled",!1),$('input[name="'+e.csrf.name+'"]').val(e.csrf.value)}))})),$("#modal-provider").on("hidden.bs.modal",(function(){e.discardNew()})),$("#modal-provider").on("show.bs.modal",(function(){e.rebuildList(),$("#provider-list .overlay").remove(),$("#provider-list .overflow-hidden").addClass("overflow-auto").removeClass("overflow-hidden"),$("#provider-list tr.table-light").removeClass("table-light")})),$('input[name="search-provider"]').on("input",(function(){var t=$(this);e.disableEditMode(),$.each($("#page-provider table tbody tr.pointer"),(function(e,n){$(n).toggleClass("search-not-match",!$(n).text().toLowerCase().includes(t.val().toLowerCase()))}))})),this.refreshSelectList()}refreshSelectList(){$('select[name="provider"]').empty().append("<option selected disabled></option>"),$.get("./provider.json",(function(e){e.length>0&&$.each(e,(function(e,t){$('select[name="provider"]').append('<option value="'+t.provider_id+'">'+t.name+"</option>")}))}))}discardNew(){$("#page-new-provider .is-invalid").removeClass("is-invalid"),$("#page-new-provider .invalid-feedback").remove(),$("#page-new-provider input").val(""),$("#page-provider").removeClass("d-none"),$("#page-new-provider").addClass("d-none")}rebuildList(){let e=this;$("#provider-list").addClass("d-none"),$("#page-provider .loader").removeClass("d-none"),$('#provider-list input[name="search-provider"]').val(""),$("#provider-list table tbody").empty(),this.getControlPanelNames((function(t){$.get("./provider.json",(function(n){$("#page-provider .loader").addClass("d-none"),$("#page-provider").find(".alert").remove(),n.length>0?($("#provider-list").removeClass("d-none"),$.each(n,(function(n,a){var o=$('<tr class="pointer">').append('<td class="editable text-truncate">'+a.name+"</td>").append('<td class="editable text-truncate text-muted">'+a.website+"</td>").append('<td class="editable text-truncate text-muted">'+a.control_panel_name+"</td>").append('<td class="editable text-truncate text-muted">'+a.control_panel_url+"</td>").append('<td class="editable text-end text-muted">'+a.total_machine+"</td>"),i=$('<i class="bi bi-pencil me-1 invisible pointer">').on("click",(function(t){t.preventDefault(),e.enableEditMode($(this).parent())})),r=$('<i class="bi bi-trash invisible pointer">').on("click",(function(e){e.preventDefault();var t=$('<div class="dropdown-menu dropdown-confirm show">'),n=$('<div class="overlay position-absolute top-0 start-0 opacity-50 bg-light w-100 h-100">'),i=$('<div class="p-2">').append('<h6>Confirm to delete <span class="text-danger">'+a.name+"</span>?</h6>");a.total_machine>0&&i.append('<small class="d-block">'+a.total_machine+" machine"+(a.total_machine>1?"s":"")+" owned by this provider will be orphaned.</small>");var r=$('<button class="btn btn-sm btn-outline-secondary" style="padding:.1rem 1rem;margin-right:.5rem">').html("No").on("click",(function(e){e.preventDefault(),n.remove(),$("#provider-list .overflow-hidden").addClass("overflow-auto").removeClass("overflow-hidden"),$(this).closest("tr").removeClass("table-light"),t.remove()})),d=$('<button class="btn btn-sm btn-danger" style="padding:.1rem 1rem">').html("Yes").on("click",(function(e){e.preventDefault(),n.remove(),$("#provider-list .overflow-hidden").addClass("overflow-auto").removeClass("overflow-hidden"),$(this).closest("tr").removeClass("table-light"),o.closest("tr").remove(),o.remove(),$.post("./provider.json",{id:a.provider_id,__CSRF_TOKEN__:$('input[name="__CSRF_TOKEN__"]').val(),action:"delete"}).fail((function(){alert("Connection lost, please try again.")})).always((function(e){$('input[name="'+e.csrf.name+'"]').val(e.csrf.value)}))}));$(".dropdown-confirm").remove(),$(this).after(t.append(i).append($('<div class="mt-1 text-center">').append(r).append(d))),t.offset({top:$(this).offset().top+$(this).outerHeight()-t.outerHeight(),left:$(this).offset().left-$(this).outerWidth()-t.outerWidth()}),$("#provider-list .overflow-auto").removeClass("overflow-auto").addClass("overflow-hidden").prepend(n),$(this).closest("tr").addClass("table-light")})),d=$('<td class="text-end" style="width: 60px;">').append(i).append(r),l=$('<input type="text" name="cp" value="'+a.control_panel_name+'" data-value="'+a.control_panel_name+'" class="form-control form-control-sm" autocomplete="off" autocapitalize="off">'),s=$('<tr class="edit d-none">').append('<td><input type="text" name="name" value="'+a.name+'" data-value="'+a.name+'" class="form-control form-control-sm"></td>').append('<td><input type="text" name="website" value="'+a.website+'" data-value="'+a.website+'" class="form-control form-control-sm"></td>').append($("<td>").append(l)).append('<td><input type="text" name="cpUrl" value="'+a.control_panel_url+'" data-value="'+a.control_panel_url+'" class="form-control form-control-sm"><input type="hidden" name="id" value="'+a.provider_id+'"></td>').append('<td class="text-end">'+a.total_machine+"</td>"),p=$('<i class="bi bi-check me-1 pointer">').on("click",(function(t){t.preventDefault(),s.find(".is-invalid").removeClass("is-invalid"),$.post("./provider.json",s.find(":input").serialize()+"&__CSRF_TOKEN__="+$('input[name="__CSRF_TOKEN__"]').val(),(function(t){Object.keys(t.errors).length>0?$.each(t.errors,(function(e,t){s.find('[name="'+e+'"]').addClass("is-invalid")})):(e.rebuildList(),e.refreshSelectList())}),"json").fail((function(){alert("Connection lost, please try again.")})).always((function(e){$('input[name="'+e.csrf.name+'"]').val(e.csrf.value)}))})),c=$('<i class="bi bi-x pointer">').on("click",(function(t){t.preventDefault(),e.disableEditMode()}));o.append(d),o.find("td.editable").on("click",(function(t){t.preventDefault(),e.enableEditMode(this)})),s.find('input[type="text"]').on("keypress",(function(e){13==e.which&&p.trigger("click")})),$("#provider-list table tbody").append(o).append(s.append($('<td class="text-end" style="width: 60px;">').append(p).append(c))),l.autoComplete({source:t})}))):$("#provider-list").addClass("d-none").after('<div class="alert alert-light mt-3">No data available.</div>')})).fail((function(){alert("Connection lost, please try again.")}))}))}getControlPanelNames(e){$.get("./provider.json?action=control-panel",(function(t){e(t)}))}disableEditMode(){$("#provider-list table tbody tr.d-none").removeClass("d-none"),$("#provider-list table tbody tr.edit:not(.d-none)").addClass("d-none")}enableEditMode(e){$("#provider-list table tbody tr.d-none").removeClass("d-none"),$("#provider-list table tbody tr.edit:not(.d-none)").addClass("d-none"),$("#provider-list table tbody tr").find(".is-invalid").removeClass("is-invalid"),$.each($("#provider-list table tbody tr").find('input[type="text"]'),(function(e,t){$(t).val($(t).attr("data-value"))})),$(e).closest("tr").addClass("d-none"),$(e).closest("tr").next().removeClass("d-none")}}